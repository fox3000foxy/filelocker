<html>
	<head>
		<script src="/socket.io/socket.io.js"></script>
		<script>
			if(!localStorage.myData) location.href = "/"
			var socket = io();
			const user = JSON.parse(localStorage.myData)
			const avatarLink = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.webp?size=4096`

			window.onload = ()=>{
				document.getElementById('avatar').src = avatarLink
				document.getElementById('name').innerText = user.username+"#"+user.discriminator
				document.getElementById('userId').value = user.id
				document.getElementById('usersList').innerHTML = 'Tapez au moins 3 lettres'
				state = document.getElementById('state')
				if(location.href.indexOf("error")!=-1) {
					state.style.backgroundColor = '#ff000099'
					state.style.border = '2px solid red'
					state.innerText = 'Il y\'a eu une erreur !'
				}
				if(location.href.indexOf("successful")!=-1) {
					state.style.backgroundColor = '#00ff0099'
					state.style.border = '2px solid lime'
					fileURI = location.origin+'/file/'+location.href.split('fileName=')[1]
					state.innerHTML = 'Le fichier a bien été uploadé, et est disponible sur <a href="'+fileURI+'">'+fileURI+'</a>'
				}
				document.getElementById('searchBar').onkeydown = ()=>{
					setTimeout(()=>{
						document.getElementById('usersList').innerHTML = 'Tapez au moins 3 lettres'
						if(document.getElementById('searchBar').value.length>2) {
							socket.emit('search',{
								name:document.getElementById('searchBar').value,
								id: myId
							})
						}
					})
				}
				document.forms.uploadForm.foo.onchange = (ev)=>{
					//document.getElementById('uploadFormSubmit').removeAttribute('disabled')
					document.getElementById('fileName').innerText = ev.target.files[0].name
					document.getElementById('userSelector').style.visibility = "visible"
				}
			}
			myId = (+new Date)// + Math.round(Math.random * 256)
			socket.on('search',({id,users})=>{
				//console.log(myId,id)
				if(myId==id) {
					//console.log(users)					
					document.getElementById('usersList').innerText = ""
					users.forEach(user=>{
						document.getElementById('usersList').appendChild(generateUser(user))
					})
					if(users.length==0)
						document.getElementById('usersList').innerText = "Aucun résultat"
				}
			})
			
			userListAdded = []
			function generateUser(user) {
				let userItem = document.createElement('div')
				userItem.onclick = ()=>{
					let selectedUserItem = document.createElement('div');
					selectedUserItem.onclick = ()=>{
						selectedUserItem.remove()
						userListAdded.splice(userListAdded.indexOf(user.id),1)
						document.forms.uploadForm.bar.value = JSON.stringify(userListAdded)
						socket.emit('search',{
								name:document.getElementById('searchBar').value,
								id: myId
						})
					}
					selectedUserItem.innerHTML = `
						<div style="padding-top:16px">
							<img src="${user.avatarLink}?size=16" style="width:32px;border-radius:16px;margin-right:4px" class="img-valign">
							<span>${user.username}<\/span>
						<\/div>
					`
					document.getElementById("usersListSelected").appendChild(selectedUserItem)
					userListAdded.push(user.id)
					document.forms.uploadForm.bar.value = JSON.stringify(userListAdded)
					userItem.remove()
				}
				if(userListAdded.indexOf(user.id)==-1) {
					userItem.innerHTML = `
						<div style="padding-top:16px">
							<img src="${user.avatarLink}?size=16" style="width:32px;border-radius:16px;margin-right:4px" class="img-valign">
							<span>${user.username}<\/span>
						<\/div>
					`
				}
				return userItem;
			}
		</script>
		<style>
			@font-face {
				 font-family: "Whitney";
				 src: url("/assets/whitneymedium.otf");
			}
			
			#usersList, input, #usersListSelected{
				--font-primary: Whitney,"Helvetica Neue",Helvetica,Arial,sans-serif;
				--text-normal: #dcddde;
				--deprecated-text-input-bg: rgba(0,0,0,0.1);
				--deprecated-text-input-border: rgba(0,0,0,0.3);
				user-select: none;
				pointer-events: all;
				-webkit-box-direction: normal;
				font-weight: 400;
				font-family: var(--font-primary);
				text-rendering: optimizeLegibility;
				outline: 0;
				font-size: 16px;
				box-sizing: border-box;
				width: 100%;
				border-radius: 3px;
				color: var(--text-normal);
				background-color: var(--deprecated-text-input-bg);
				border: 1px solid var(--deprecated-text-input-border);
				transition: border-color .2s ease-in-out;
				padding: 10px;
				width:250px;
				//height: 120px;
				margin:auto;
			}
			input{
				height: 40px;
			}
			.img-valign {
			  vertical-align: middle;
			  margin-bottom: 0.50em;
			}
		</style>
		<link rel="stylesheet" href="styles/buttons.css">
	</head>
	<body bgColor="#2c2f33" style="text-align:center;color:white;font-family:Whitney;">
		<header style="background-color:#23272a; padding:10px">
			<div id="userGroup"><br>
				<img id="avatar" style="
					width:64px;
					border-radius:32px
				"><br>
				<span id="name" style="
					font-style:bold;
				"></span><br><br>
			</div>
		</header><br>
		<span id="state"></span>
		<form method="POST" action="/upload" encType="multipart/form-data" name="uploadForm"
		onsubmit='submitting()'>
			<input type="hidden" name="id" id="userId"><br><br>
			<input type="file" name="foo" hidden>
			<input name="bar" hidden>
			<span id="fileName">Aucun fichier</span><br><br>
			<button class="blue" onclick="
				event.preventDefault();
				document.forms.uploadForm.foo.click()
			" style="width:150px">Importer un fichier</button><br><br><br>
			
			<div id="userSelector" style="visibility:hidden">
				<input id="searchBar">
				<div id="usersList" style="text-align:center"></div>
				<table id="usersListSelected" style="height:280px;text-align:center"><tr></tr></table>
				<br><br>
				<button class="red" id="uploadFormSubmit" style="width:150px">Envoyer</button>
			</div>
		</form>
		<img src="/assets/outgoing.png" style="
			width:64px;
			position:absolute;
			right: 16px;
			bottom: 16px;
		" onclick="localStorage.clear();location.href='/'">
	</body>
</html>