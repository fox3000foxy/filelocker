<html>
	<head>
		<script src="/socket.io/socket.io.js"></script>
		<script>
			var socket = io();
			const user = JSON.parse(localStorage.myData)
			const avatarLink = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.webp?size=4096`

			window.onload = ()=>{
				document.getElementById('avatar').src = avatarLink
				document.getElementById('name').innerText = user.username+"#"+user.discriminator
				document.getElementById('userId').value = user.id
				document.getElementById('usersList').innerHTML = 'Tapez au moins 3 lettres'
				document.getElementById('searchBar').onkeydown = ()=>{
					setTimeout(()=>{
						document.getElementById('usersList').innerHTML = 'Tapez au moins 3 lettres'
						if(document.getElementById('searchBar').value.length>2) {
							socket.emit('search',{
								name:document.getElementById('searchBar').value,
								id: myId
							})
						}
					})
				}
			}
			myId = (+new Date)// + Math.round(Math.random * 256)
			socket.on('search',({id,users})=>{
				//console.log(myId,id)
				if(myId==id) {
					//console.log(users)					
					document.getElementById('usersList').innerText = ""
					users.forEach(user=>{
						document.getElementById('usersList').appendChild(generateUser(user,"add"))
					})
					if(users.length==0)
						document.getElementById('usersList').innerText = "Aucun rÃ©sultat"
				}
			})
			
			userListAdded = []
			function generateUser(user,mode) {
				let userItem = document.createElement('div')
				if(mode=="add")
					userItem.onclick = ()=>{
						<!-- let selectedUserItem = document.createElement('div'); -->
						document.getElementById("usersListSelected").innerHTML += `
							<div style="padding-top:16px">
								<img src="${user.avatarLink}?size=16" style="width:32px;border-radius:16px;margin-right:4px" class="img-valign">
								<span>${user.username}<\/span>
							<\/div>
						`
						userListAdded.push(user.id)
						userItem.remove()
					}
				if(userListAdded.indexOf(user.id)==-1) {
					userItem.innerHTML = `
						<div style="padding-top:16px">
							<img src="${user.avatarLink}?size=16" style="width:32px;border-radius:16px;margin-right:4px" class="img-valign">
							<span>${user.username}<\/span>
						<\/div>
					`
				}
				return userItem;
			}
		</script>
		<style>
			@font-face {
				 font-family: "Whitney";
				 src: url("/assets/whitneymedium.otf");
			}
			
			#usersList, input, #usersListSelected{
				--font-primary: Whitney,"Helvetica Neue",Helvetica,Arial,sans-serif;
				--text-normal: #dcddde;
				--deprecated-text-input-bg: rgba(0,0,0,0.1);
				--deprecated-text-input-border: rgba(0,0,0,0.3);
				user-select: none;
				pointer-events: all;
				-webkit-box-direction: normal;
				font-weight: 400;
				font-family: var(--font-primary);
				text-rendering: optimizeLegibility;
				outline: 0;
				font-size: 16px;
				box-sizing: border-box;
				width: 100%;
				border-radius: 3px;
				color: var(--text-normal);
				background-color: var(--deprecated-text-input-bg);
				border: 1px solid var(--deprecated-text-input-border);
				transition: border-color .2s ease-in-out;
				padding: 10px;
				width:250px;
				//height: 120px;
				margin:auto;
			}
			input{
				height: 40px;
			}
			.img-valign {
			  vertical-align: middle;
			  margin-bottom: 0.50em;
			}
		</style>
		<link rel="stylesheet" href="styles/buttons.css">
	</head>
	<body bgColor="#2c2f33" style="text-align:center;color:white;font-family:Whitney;">
		<header style="background-color:#23272a; padding:10px">
			<div id="userGroup"><br>
				<img id="avatar" style="
					width:64px;
					border-radius:32px
				"><br>
				<span id="name" style="
					font-style:bold;
				"></span><br><br>
			</div>
		</header>
		<form method="POST" action="/upload" encType="multipart/form-data" name="uploadForm">
			<input type="hidden" name="id" id="userId"><br><br>
			<input type="file" name="foo" hidden>
			<span id="fileName">Aucun fichier</span><br>
			<button class="blue" onclick="
				event.preventDefault();
				document.forms.uploadForm.foo.click()
			" style="width:150px">Importer un fichier</button><br><br>
			<br><br>
			<input id="searchBar">
			<div id="usersList" style="text-align:center"></div>
			<table id="usersListSelected" style="height:280px;text-align:center"><tr></tr></table>
			<br><br>
			<button class="red" onclick="this.form.submit()" style="width:150px">Envoyer</button>
		</form>
		<img src="/assets/outgoing.png" style="
			width:64px;
			position:absolute;
			right: 16px;
			bottom: 16px;
		" onclick="localStorage.clear();location.href='/'">
	</body>
</html>